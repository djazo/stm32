# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

STM32 register definitions library using Intel GROOV (Generic Register Operation Optimizer). This is a header-only C++23 library providing type-safe, compile-time optimized access to STM32 peripheral registers.

## Build Commands

```bash
# This is a header-only library consumed as a Meson subproject
# No standalone build - used via parent project's meson.build:
#   stm32_sub = subproject('stm32')
#   stm32_dep = stm32_sub.get_variable('stm32_dep')

# Regenerate headers from all SVD files (with deduplication)
./scripts/svd2groov.py svd/*.svd -o include/stm32/ --verbose --stats

# Format code
clang-format -i <file>
```

## Architecture

### Directory Structure
- `include/stm32/common/` - Shared access types and bit type definitions
- `include/stm32/<mcu>/` - MCU headers (one file per MCU)
- `include/stm32/<mcu>/registers/' - register definitions
- `include/stm32/<mcu>/peripherals/' - peripheral definitions
- `include/stm32/<mcu>/<mcu>.hpp' - instantiations if config has peripheral enabled
- `svd/` - STM32 SVD source files
- `scripts/` - Code generation scripts

### Code Generation

Headers are auto-generated by `svd2groov.py` from STM32 SVD files. The script:
1. Parses SVD file for mcu
2. Computes register signatures based on field layouts
3. Deduplicates identical register definitions
4. Groups templates by peripheral type into header files in `registers/`
5. Generates thin MCU aggregates that reference shared templates

### Register Definition Pattern

Shared register templates grouped by peripheral type in `registers/`:
```cpp
// registers/tim.hpp - All timer register variants
namespace stm32::registers {

// TIM peripheral register templates

// tim_cr1_v1: CR1 (version 1)
// Used by: TIM1.CR1@stm32f0x0, TIM2.CR1@stm32f0x1, ...
template <stdx::ct_string name,
          std::uint32_t   baseaddress,
          std::uint32_t   offset>
using tim_cr1_v1_tt =
  groov::reg<name, std::uint32_t, baseaddress + offset,
             access::rw,
             groov::field<"ckd", std::uint8_t, 9, 8>,
             groov::field<"arpe", bool, 7, 7>,
             // ...
             groov::field<"cen", bool, 0, 0>>;

// tim_cr1_v2: CR1 (version 2) - different layout
// ...

} // namespace stm32::registers
```

MCU aggregates in `<mcu>/<mcu>.hpp`:
```cpp
// stm32f103/stm32f103.hpp - MCU aggregate
#include <stm32/<mcu>/registers/tim.hpp>
#include <stm32/<mcu>/registers/usart.hpp>
// ... other peripheral types used by this MCU

namespace stm32 {
namespace tim2 {
  constexpr std::uint32_t TIM2_BASE = 0x4000'0000;

  using cr1_tt = registers::tim_cr1_v1_tt;  // Alias to shared template

  template <std::uint32_t baseaddress>
  using tim2_t = groov::group<"tim2", groov::mmio_bus<>,
                              cr1_tt<"cr1", baseaddress, 0>,
                              // ...
                              >;

} // namespace tim2

  constexpr auto tim2 = tim2::tim2_t<tim2::TIM2_BASE>{};
} // namespace stm32
```

### Access Types (`common/access.hpp`)
- `rw` - Read-write (replace on write)
- `ro` - Read-only (writes ignored)
- `wo` - Write-only
- `wr1` - Write-1-to-clear

### Key Dependency
- **GROOV** (`generic-register-operation-optimizer`): Provides compile-time register access optimization

## Code Style

- C++23
- 80-column line limit, 2-space indentation
- Pointer alignment: right (e.g., `int *ptr`)
- Use `.clang-format` for formatting
